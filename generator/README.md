This directory contains the files necessary to generate the `trace2html` script.

The files are:
* `trace2html.in`: an input template with placeholders for bytestrings.
* `generate_trace2html.py`: the script to invoke to generate `trace2html`.

The `trace2html` program is generated by the script, using an HTML file that
itself will be generated by the trace2html.py program in Google's catapult library.

# Steps to generate the `trace2html` program

1. Clone [Google's catapult repo](https://chromium.googlesource.com/catapult): `git clone https://chromium.googlesource.com/catapult`
2. Invoke `generate_trace2html <path/to/catapult>`.
3. If all goes well, it should generate the `trace2html` in the file you invoked it from.


# Troubleshooting

If you hit an assertion, due to `AssertIsUTF8` in catapult's code, it's due to [a bug](https://bugs.chromium.org/p/chromium/issues/detail?id=1333290).

You need to change one line: `path/to/catapult/common/py_vulcanize/py_vulcanize/generate.py` line `75`, from this:
```py
  assert f.encoding == 'utf-8'
```
To this:
```py
  assert f.encoding == 'UTF-8'
```
(or `assert f.encoding.upper() == 'UTF-8'` if you want to be future-proof)


# Details

Internally, `generate_trace2html.py` does the following:

   1. Generates the HTML file via catapult using a dummy trace file.
   2. Reads in the generated HTML file and breaks it into 3 sections:
      * The head and meta tags up to the `<title>` tag.
      * Everything between the closing `</title>` tag and `<script id="viewer-data" ...>` tags.
      * Everything after the closing `</script>` tag.
   3. The first and last sections are short and will be written base-64
      encoded but not gzip'ed, into the `trace2html.in` template's spots for
      them, as python bytestrings.
   4. The middle section is huge, and will be gzip'ed and base64-encoded
      into another python bytestring location in the `trace2html.in` template.
   5. The filled-out `trace2html.in` template will then be written as a new
      `trace2html` output executable file.

The generated HTML file is not deleted, but should not be checked into this
repo. It's only left around to help troubleshoot.
